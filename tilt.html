<!DOCTYPE html>
<html>
<body style="background:#111;color:white;text-align:center;font-family:sans-serif;padding-top:40px;">

<h2>Tilt Controlled Stepper</h2>

<input id="ip" placeholder="ESP32 IP">
<br><br>
<button onclick="connect()">Connect</button>
<button onclick="start()">Enable Tilt</button>

<h3 id="status">Not Connected</h3>
<h1 id="angle">0°</h1>

<script>

let ws;

function connect(){
  let ip = document.getElementById("ip").value;
  ws = new WebSocket("ws://" + ip + ":81");

  ws.onopen = function(){
    document.getElementById("status").innerHTML="Connected";
  };

  ws.onerror = function(){
    document.getElementById("status").innerHTML="Connection Failed";
  };
}

function start(){

  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
    .then(response => {
      if (response === 'granted') {
        window.addEventListener('deviceorientation', sendTilt);
      }
    });
  } else {
    window.addEventListener('deviceorientation', sendTilt);
  }
}

function sendTilt(event){

  let tilt = event.beta;

  if (tilt == null) return;

  if (tilt < 0) tilt = 0;
  if (tilt > 180) tilt = 180;

  let angle = Math.round(tilt);

  document.getElementById("angle").innerHTML = angle + "°";

  if (ws && ws.readyState === 1) {
    ws.send(angle.toString());
  }
}

</script>

</body>
</html>
